<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - HD Sports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #111827; }
        [x-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #1f2937; } ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .transition-all-300 { transition: all 0.3s ease-in-out; }
        .input-field { background-color: #374151; border: 1px solid #4b5563; color: white; border-radius: 0.5rem; padding: 0.75rem 1rem; transition: all 0.2s ease; }
        .input-field:focus { outline: none; border-color: #f97316; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.5); }
        .btn { padding: 0.6rem 1.25rem; border-radius: 0.5rem; font-weight: 600; text-align: center; transition: all 0.2s ease; cursor: pointer; }
        .btn-primary { background-color: #f97316; color: white; } .btn-primary:hover { background-color: #ea580c; }
        .btn-secondary { background-color: #4b5563; color: white; } .btn-secondary:hover { background-color: #6b7280; }
        @media print { body > *:not(#printable-area) { visibility: hidden; } #printable-area, #printable-area * { visibility: visible; } #printable-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; z-index: 9999; } }
    </style>
</head>

<body>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"><div class="text-white text-xl">Đang kiểm tra quyền truy cập...</div></div>

    <div id="admin-content" x-data="adminPanel()" x-cloak class="hidden">
        <header class="bg-gray-800 shadow-lg sticky top-0 z-30"><nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20"><a href="index.html" class="text-3xl font-bold text-white">HD <span class="text-orange-500">Sports</span></a><div id="auth-container"></div></nav></header>
        
        <main class="container mx-auto px-4 py-10">
            <div class="mb-8 border-b border-gray-700"><nav class="flex space-x-2 sm:space-x-4" aria-label="Quản lý Tabs"><button @click="activeTab = 'orders'" :class="activeTab === 'orders' ? 'border-orange-500 text-orange-500' : 'border-transparent text-gray-400 hover:text-white'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-all-300">Đơn hàng</button><button @click="activeTab = 'products'" :class="activeTab === 'products' ? 'border-orange-500 text-orange-500' : 'border-transparent text-gray-400 hover:text-white'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-all-300">Sản phẩm</button><button @click="activeTab = 'vouchers'" :class="activeTab === 'vouchers' ? 'border-orange-500 text-orange-500' : 'border-transparent text-gray-400 hover:text-white'" class="whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm transition-all-300">Voucher</button></nav></div>

            <div x-show="activeTab === 'products'" x-cloak><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-white">Tất cả sản phẩm (<span x-text="productCount"></span>)</h2></div><div class="bg-gray-800 rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-700"><thead class="bg-gray-900/50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Sản phẩm</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cửa hàng</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Giá</th></tr></thead><tbody class="divide-y divide-gray-700"><template x-for="product in products" :key="product.id"><tr><td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><div class="flex-shrink-0 h-10 w-10"><img class="h-10 w-10 rounded-full object-cover" :src="product.imageUrl" :alt="product.name" /></div><div class="ml-4"><div class="text-sm font-medium text-white" x-text="product.name"></div><div class="text-sm text-gray-400" x-text="`SKU: ${product.sku}`"></div></div></div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="product.storeName"></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="formatCurrency(product.price)"></td></tr></template></tbody></table></div></div>

            <div x-show="activeTab === 'orders'" x-cloak><div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4"><h2 class="text-2xl font-bold text-white">Quản lý Đơn hàng</h2><div class="relative"><input type="text" x-model.debounce.300ms="orderSearchTerm" placeholder="Tìm kiếm đơn hàng..." class="input-field w-full md:w-64 pl-10"><svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div></div><div class="flex flex-wrap gap-2 mb-6"><template x-for="status in Object.keys(orderCounts)" :key="status"><button @click="setFilter(status)" :class="{ 'bg-orange-600 text-white': activeFilter === status, 'bg-gray-700 text-gray-300 hover:bg-gray-600': activeFilter !== status }" class="px-3 py-1.5 rounded-full text-sm font-medium transition-all-300" x-text="`${status === 'all' ? 'Tất cả' : status} (${orderCounts[status]})`"></button></template></div><div class="space-y-4"><template x-if="filteredOrders.length === 0"><p class="text-center text-gray-400 bg-gray-800 p-8 rounded-lg">Không tìm thấy đơn hàng nào.</p></template><template x-for="order in filteredOrders" :key="order.id"><div class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700/50"><div class="flex flex-col md:flex-row justify-between md:items-start border-b border-gray-700 pb-3 mb-3"><div><p class="font-semibold text-white">Mã ĐH: <span class="text-orange-400 font-mono" x-text="order.id"></span></p><p class="text-sm text-gray-400" x-text="`Ngày: ${formatDate(order.createdAt)}`"></p></div><div class="text-lg font-bold text-white mt-2 md:mt-0 text-right"><span x-show="order.discountAmount > 0" class="text-sm text-gray-400 line-through" x-text="formatCurrency(order.totalAmount + order.discountAmount)"></span> <span x-text="formatCurrency(order.totalAmount)"></span></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-4"><div class="text-sm space-y-1"><p class="text-gray-300"><strong class="font-medium text-gray-200">Khách hàng:</strong> <span x-text="order.customerInfo.name"></span></p><p class="text-gray-300"><strong class="font-medium text-gray-200">SĐT:</strong> <span x-text="order.customerInfo.phone"></span></p><p class="text-gray-300"><strong class="font-medium text-gray-200">Địa chỉ:</strong> <span x-text="order.customerInfo.address"></span></p><p x-show="order.appliedVoucher" class="text-gray-300"><strong class="font-medium text-gray-200">Voucher:</strong> <span class="font-mono bg-green-800/50 text-green-300 px-2 py-0.5 rounded" x-text="order.appliedVoucher"></span></p></div><div class="text-sm space-y-1"><details class="cursor-pointer"><summary class="text-gray-400 hover:text-white">Chi tiết sản phẩm...</summary><ul class="list-disc pl-5 mt-2 space-y-1 text-gray-300"><template x-for="item in order.items" :key="item.id + item.name"><li><span x-text="`${item.name} (x${item.quantity})`"></span> - <span class="text-gray-400" x-text="item.storeName"></span><span x-show="item.printing_notes" class="ml-2 text-red-400" x-text="`[In: ${item.printing_notes}]`"></span><div x-show="item.selectedOptions" class="text-xs text-gray-400 ml-1" x-text="Object.entries(item.selectedOptions).map(([key, val]) => `${key}: ${val}`).join(', ')"></div></li></template></ul></details><p x-show="order.notes" class="text-gray-300 bg-gray-700/50 p-2 rounded-md mt-2"><strong class="font-medium text-gray-200">Ghi chú:</strong> <span x-text="order.notes"></span></p></div></div><div class="mt-4 flex items-center justify-between"><div><label class="text-sm font-medium text-gray-300">Trạng thái: </label><select @change="updateOrderStatus(order.id, $event.target.value)" :value="order.status" class="bg-gray-700 text-white rounded p-1 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"><option value="Chờ xác nhận">Chờ xác nhận</option><option value="Đang xử lý">Đang xử lý</option><option value="Đang giao hàng">Đang giao hàng</option><option value="Đã giao hàng">Đã giao hàng</option><option value="Đã hủy">Đã hủy</option><option value="Đã hoàn tiền">Đã hoàn tiền</option></select></div><button @click="printOrder(order)" class="btn btn-secondary text-sm">In hóa đơn</button></div></div></template></div></div>
            
            <div x-show="activeTab === 'vouchers'" x-cloak><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Quản lý Voucher</h2><button @click="isVoucherModalOpen = true" class="btn btn-primary">Tạo Voucher</button></div><div class="bg-gray-800 rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-700"><thead class="bg-gray-900/50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Mã</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Giá trị</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Đã dùng</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase">Hành động</th></tr></thead><tbody class="divide-y divide-gray-700"><template x-if="vouchers.length === 0"><tr><td colspan="4" class="text-center py-6 text-gray-400">Chưa có voucher nào.</td></tr></template><template x-for="voucher in vouchers" :key="voucher.id"><tr><td class="px-6 py-4 whitespace-nowrap text-sm font-mono font-medium text-white" x-text="voucher.id"></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="voucher.type === 'fixed' ? formatCurrency(voucher.value) : `${voucher.value}%`"></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300" x-text="`${voucher.usageCount || 0} / ${voucher.maxUses}`"></td><td class="px-6 py-4 whitespace-nowrap text-sm"><button @click="deleteVoucher(voucher.id)" class="text-red-400 hover:text-red-500 transition-all-300">Xóa</button></td></tr></template></tbody></table></div></div>
        </main>
        
        <div x-show="isVoucherModalOpen" @keydown.escape.window="isVoucherModalOpen = false" class="fixed inset-0 z-40 overflow-y-auto" style="display: none;" x-cloak><div class="flex items-center justify-center min-h-screen"><div x-show="isVoucherModalOpen" x-transition.opacity class="fixed inset-0 bg-black/60 backdrop-blur-sm"></div><div x-show="isVoucherModalOpen" x-transition class="relative bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-lg p-6 m-4"><h3 class="text-xl font-bold text-white mb-4">Tạo Voucher Mới</h3><form @submit.prevent="saveVoucher" class="space-y-4"><div><label class="block text-gray-400 mb-1 text-sm">Mã Voucher</label><input type="text" x-model="newVoucher.code" @input="newVoucher.code = $event.target.value.toUpperCase()" class="input-field w-full uppercase font-mono"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-gray-400 mb-1 text-sm">Loại giảm giá</label><select x-model="newVoucher.type" class="input-field w-full"><option value="fixed">Số tiền cố định (VND)</option><option value="percent">Phần trăm (%)</option></select></div><div><label class="block text-gray-400 mb-1 text-sm">Giá trị</label><input type="number" x-model.number="newVoucher.value" min="0" class="input-field w-full"></div></div><div><label class="block text-gray-400 mb-1 text-sm">Tổng lượt sử dụng</label><input type="number" x-model.number="newVoucher.maxUses" min="1" class="input-field w-full"></div><div><label class="block text-gray-400 mb-1 text-sm">Mô tả (tùy chọn)</label><input type="text" x-model="newVoucher.description" class="input-field w-full"></div><div class="flex justify-end space-x-3 pt-4"><button type="button" @click="isVoucherModalOpen = false" class="btn btn-secondary">Hủy</button><button type="submit" class="btn btn-primary">Lưu</button></div></form></div></div></div>
    </div>
    <div id="printable-area" class="hidden"></div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="./js/firebase-config.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/admin.js"></script>
</body>
</html>